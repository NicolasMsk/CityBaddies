# Dockerfile pour Cloud Run Job - Enrichissement Prix Concurrents
# Utilise Playwright pour le scraping + GPT-4o-mini Vision
FROM mcr.microsoft.com/playwright:v1.57.0-jammy

WORKDIR /app

# Installer Node.js 20
RUN apt-get update && apt-get install -y curl && \
    curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && \
    apt-get install -y nodejs && \
    rm -rf /var/lib/apt/lists/*

# Copier les fichiers de dépendances
COPY package*.json ./
COPY prisma ./prisma/
COPY tsconfig.json ./

# Installer les dépendances
RUN npm ci
RUN npm install -g tsx

# Générer le client Prisma
RUN npx prisma generate

# Copier le code source nécessaire
COPY src/lib ./src/lib/
COPY src/scripts/cloud-jobs/enrich-competitor-prices.ts ./src/scripts/cloud-jobs/

# Variables d'environnement (seront override par Cloud Run)
ENV NODE_ENV=production

# Commande d'exécution
CMD ["npx", "tsx", "src/scripts/cloud-jobs/enrich-competitor-prices.ts"]
